----------
12/24/2016 1:34:58 PM 

----------
# 数据访问层 #
	随着数据量和访问量的上升，应用使用的数据库也会遇到问题，这就需要数据访问层。
1. 数据库从单机到分布式的挑战和应对
	- 单机数据库 
		- 应用程序-->JVM-->DJBC-->数据库
	- 数据库垂直、水平拆分困难
		- 数据库减压
			- 优化应用
			- 引入缓存、加搜索引擎等
			- 把数据库的数据和访问分到多台数据库上，分开支持
		- 垂直拆分
			- 不同业务单元分到不同的数据库中
				- 单机的ACID保证被打破
				- Join操作困难
				- 外键约束受到影响
		- 水平拆分
			- 根据一定规则把同一业务单元的数据拆分到多个数据库中
				- ACID被打破
				- join操作困难
				- 外键约束受影响
				- 依赖单库的自增序列生成唯一ID会受影响
				- 针对单个逻辑意义的表的查询要跨库
	- 单机变为多机后的事务处理
		- 分布式事务
			- 指事务的参与者、支持事务的服务器、资源服务器、事务管理器分别位于分布式系统的不同节点上
				- 最终一致
				- 补偿机制
			- Application Program
				- 定义事务边界并定义构成该事务的应用程序的特定操作
			- Resource Manager
				- 应用程序通过资源管理器对资源进行控制
				- 可以理解为一个DBMS或消息服务管理系统
			- Transaction Manager
				- 协调和管理事务
					- 向事务指定标识，监视事务的进程，并负责处理事务的完成和失败
				- 提供给应用程序编程接口并管理资源管理器
		- DTP中几个概念
			- 事务
			- 全局事务
			- 分支事务
			- 控制线程
		- 两阶段提交
			- 2PC：Two Phase Commitment Protocol
			- 开销增大
				- 网络上交互次数增多
				- 引入事务管理器的开销
		- 大型网站一致性的基础理论-CAP/BASE
			- CAP理论
				- Consistency
				- Availability
				- Partition-Tolerance
			- Base模型
				- Basically Available
				- Soft State
				- Eventually consistent
		- Paxos协议
			
	- 多机的Sequence问题
		- 性能问题
		- 生成器的稳定性问题
		- 存储的问题
	- 应对多机的数据查询
		- 跨库Join
			- 应用层分多次数据库操作
			- 数据冗余
			- 借助外部系统，如搜索引擎
		- 外键约束	
			- 单库数据内聚
			- 应用层的判断、容错
		- 跨库查询
			- 排序
			- 函数处理
			- 求平均值
			- 非排序分页
			- 排序后分页
	- 数据访问层的设计与实现
		- 对外提供数据访问的方式
			- 为用户提供专有API
			- 通用方式
				- 实现JDBC接口
			- 基于ORM或类ORM据诶口的方式
		- 按照数据层流程的顺序看数据层的设计
			- SQL解析
			- 规则处理
				- 采用固定哈希算法作为规则
				- 一致性哈希
				- 虚拟节点对一致性哈希的改进
				- 映射表与规则自定义计算方式
			- SQL改写
			- 数据源选择
			- SQL执行
			- 结果集返回合并处理
	- 数据库访问层的实现方式
		- jar包方式
		- Proxy方式
			- 数据库协议
			- 私有协议
	- 读写分离的挑战和应对
		- 主库从库非对称场景
			- 数据结构相同，多从库对应一主库场景
				- 消息解决数据同步方案
			- 主/备库分库方式不同的数据复制
			- 引入数据变更平台
		- 数据平滑迁移

## 总结 ##
数据层读写时不仅涉及到数据库还用到分布式文件系统、缓存系统、搜索系统等。数据层统一封装，对外提供统一的接口。